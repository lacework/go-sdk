//
// Author:: Salim Afiune Maya (<afiune@lacework.net>)
// Copyright:: Copyright 2021, Lacework Inc.
// License:: Apache License, Version 2.0
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//

package cmd

import (
	"encoding/json"
	"strings"
	"testing"

	"github.com/pkg/errors"
	"github.com/stretchr/testify/assert"

	"github.com/lacework/go-sdk/api"
	"github.com/lacework/go-sdk/internal/capturer"
)

func TestUserFriendlyErrorFromOnDemandCtrVulnScanRepositoryNotFound(t *testing.T) {
	err := userFriendlyErrorForOnDemandCtrVulnScan(
		errors.New("Could not successfully send scan request to available integrations for given repo and label"),
		"my-registry.example.com", "image", "tag",
	)
	if assert.NotNil(t, err) {
		assert.Contains(t,
			err.Error(),
			"container image 'image@tag' not found in registry 'my-registry.example.com'")
		assert.Contains(t,
			err.Error(),
			"To view all container registries configured in your account use the command:")
		assert.Contains(t,
			err.Error(),
			"lacework vulnerability container list-registries")
	}
}

func TestBuildCSVVulnCtrReportVulnerabilitiesListing(t *testing.T) {
	cli.EnableCSVOutput()
	defer func() { cli.csvOutput = false }()

	var data api.VulnContainerAssessmentsResponse
	if err := json.Unmarshal([]byte(rawListAssesments), &data); err != nil {
		panic(err)
	}

	headers := []string{"Registry", "Repository", "Last Scan", "Status", "Containers", "Vulnerabilities", "Image Digest"}
	assessments := filterVulnAssessments(data.Assessments)
	filteredAssessments := filterAssessments(assessments)
	rows := vulAssessmentsToTable(filteredAssessments)
	csv, err := renderAsCSV(headers, rows)
	if err != nil {
		panic(err)
	}

	expected := `
Registry,Repository,Last Scan,Status,Containers,Vulnerabilities,Image Digest
remote_scanner,ubuntu,2022-01-07T01:49:12Z,Success,0,3 Medium 0 Fixable,sha256:626ffe58f6e7566e00254b638eb7e0f3b11d4da9675088f4781a50ae288f3322
remote_scanner,example/voteapp,2022-01-07T01:47:55Z,Success,0,1 High 1 Fixable,sha256:78018fb907b434dce7a17efbcc444b3fd4b442d99e0f23356af332c89b91932a
remote_scanner,postgres,2022-01-07T01:48:43Z,Success,0,3 Critical 113 Fixable,sha256:42a7a6a647a602efa9592edd1f56359800d079b93fa52c5d92244c58ac4a2ab9
remote_scanner,example/worker,2022-01-07T01:48:27Z,Success,0,8 High 16 Fixable,sha256:ec15a3cc5efa3adc2393b973b08196e25c59d48a992c0a505d6e536728c9a61a
remote_scanner,redis,2022-01-07T01:48:39Z,Success,0,None,sha256:4bed291aa5efb9f0d77b76ff7d4ab71eee410962965d052552db1fb80576431d
remote_scanner,example/resultsapp,2022-01-07T01:51:21Z,Success,0,5 Critical 104 Fixable,sha256:9c92e73081a89569d6ac9b832b5f094e401d68d98bdf71d0fc54286ebaf88677
`

	assert.Equal(t, strings.TrimPrefix(expected, "\n"), csv)
}

func TestBuildCSVVulnCtrReportWithVulnerabilities(t *testing.T) {
	cli.EnableCSVOutput()
	vulCmdState.Details = true
	defer func() {
		cli.csvOutput = false
		vulCmdState.Details = false
	}()

	var response api.VulnContainerAssessmentResponse
	if err := json.Unmarshal([]byte(rawContainerAssesment), &response); err != nil {
		panic(err)
	}
	cliOutput := capturer.CaptureOutput(func() {
		assert.Nil(t, buildVulnContainerAssessmentReports(&response.Data))
	})

	expected := `
CVE ID,Severity,CVSSv2,CVSSv3,Package,Current Version,Fix Version,Introduced in Layer
CVE-2020-16156,Medium,6.8,7.8,perl,5.30.0-9ubuntu0.2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2021-38604,Medium,5.0,7.5,glibc,2.31-0ubuntu9.2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2021-35942,Medium,6.4,9.1,glibc,2.31-0ubuntu9.2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2019-18276,Low,7.2,7.8,bash,5.0-6ubuntu1.1,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2020-27618,Low,2.1,5.5,glibc,2.31-0ubuntu9.2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2021-27645,Low,1.9,2.5,glibc,2.31-0ubuntu9.2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2021-3326,Low,5.0,7.5,glibc,2.31-0ubuntu9.2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2020-6096,Low,6.8,8.1,glibc,2.31-0ubuntu9.2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2016-2781,Low,2.1,6.5,coreutils,8.30-3ubuntu2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2021-33574,Low,7.5,9.8,glibc,2.31-0ubuntu9.2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2019-1010023,Low,6.8,8.8,glibc,2.31-0ubuntu9.2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2019-1010024,Low,5.0,5.3,glibc,2.31-0ubuntu9.2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2019-25013,Low,7.1,5.9,glibc,2.31-0ubuntu9.2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2019-1010022,Low,7.5,9.8,glibc,2.31-0ubuntu9.2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2020-13776,Low,6.2,6.7,systemd,245.4-4ubuntu3.13,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2013-4235,Low,3.3,4.7,shadow,1:4.8.1-1ubuntu5.20.04.1,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2019-20838,Low,4.3,7.5,pcre3,2:8.39-12build1,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2020-29562,Low,2.1,4.8,glibc,2.31-0ubuntu9.2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2021-43618,Low,5.0,7.5,gmp,2:6.2.0+dfsg-4,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2020-14155,Info,5.0,5.3,pcre3,2:8.39-12build1,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2017-11164,Info,7.8,7.5,pcre3,2:8.39-12build1,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2018-1000654,Info,7.1,5.5,libtasn1-6,4.16.0-2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2016-10228,Info,4.3,5.9,glibc,2.31-0ubuntu9.2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
CVE-2018-20796,Info,5.0,7.5,glibc,2.31-0ubuntu9.2,,ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / 
`
	assert.Equal(t, strings.TrimPrefix(expected, "\n"), cliOutput)
}

var rawListAssesments = `{"data":[{"eval_guid":"dbcd7b8a8da19ab6a144243e577a98c0","eval_status":"PASSED","eval_type":"EvalByAthena","image_created_time":"2021-10-16T00:37:47.578Z","image_digest":"sha256:626ffe58f6e7566e00254b638eb7e0f3b11d4da9675088f4781a50ae288f3322","image_id":"sha256:ba6acccedd2923aee4c2acc6a23780b14ed4b8a5fa4e14e252a23b846df9b6c1","image_namespace":"","image_registry":"remote_scanner","image_repo":"ubuntu","image_scan_error_msg":"[]","image_scan_status":"Success","image_scan_time":"1970-01-01T00:00:00Z","image_size":"72773644","image_tags":["latest"],"ndv_containers":"0","num_fixes":"0","num_vulnerabilities_severity_1":"0","num_vulnerabilities_severity_2":"0","num_vulnerabilities_severity_3":"3","num_vulnerabilities_severity_4":"16","num_vulnerabilities_severity_5":"5","start_time":"2022-01-07T01:49:12.177Z"},{"eval_guid":"f4575f75f6e7ff9fbb8ba255b38dfb8f","eval_status":"PASSED","eval_type":"EvalByAthena","image_created_time":"2021-10-26T22:50:17.867Z","image_digest":"sha256:78018fb907b434dce7a17efbcc444b3fd4b442d99e0f23356af332c89b91932a","image_id":"sha256:7986d5ad04d4e42dbbb066de703644dc2b0f222a5da99face2624351c7025169","image_namespace":"","image_registry":"remote_scanner","image_repo":"example/voteapp","image_scan_error_msg":"[]","image_scan_status":"Success","image_scan_time":"1970-01-01T00:00:00Z","image_size":"143612353","image_tags":["latest"],"ndv_containers":"0","num_fixes":"1","num_vulnerabilities_severity_1":"0","num_vulnerabilities_severity_2":"1","num_vulnerabilities_severity_3":"7","num_vulnerabilities_severity_4":"6","num_vulnerabilities_severity_5":"40","start_time":"2022-01-07T01:47:55.845Z"},{"eval_guid":"e4333945628a23924849fbdb041127b0","eval_status":"PASSED","eval_type":"EvalByAthena","image_created_time":"2020-02-14T17:47:19.734Z","image_digest":"sha256:42a7a6a647a602efa9592edd1f56359800d079b93fa52c5d92244c58ac4a2ab9","image_id":"sha256:ed5a45034282ac21bc29a96f76bf0127843a477c325c4ff2264633a3981bce1a","image_namespace":"","image_registry":"remote_scanner","image_repo":"postgres","image_scan_error_msg":"[]","image_scan_status":"Success","image_scan_time":"1970-01-01T00:00:00Z","image_size":"250684311","image_tags":["9.4"],"ndv_containers":"0","num_fixes":"113","num_vulnerabilities_severity_1":"3","num_vulnerabilities_severity_2":"29","num_vulnerabilities_severity_3":"92","num_vulnerabilities_severity_4":"45","num_vulnerabilities_severity_5":"62","start_time":"2022-01-07T01:48:43.566Z"},{"eval_guid":"7395dd77f4fcd8b30624314b7925e055","eval_status":"PASSED","eval_type":"EvalByAthena","image_created_time":"2021-10-06T00:03:33.605Z","image_digest":"sha256:ec15a3cc5efa3adc2393b973b08196e25c59d48a992c0a505d6e536728c9a61a","image_id":"sha256:81132a1fd36ebabcb44d15aa825c8a5440dccc243fb2f71f8cdc8c21f8b38191","image_namespace":"","image_registry":"remote_scanner","image_repo":"example/worker","image_scan_error_msg":"[]","image_scan_status":"Success","image_scan_time":"1970-01-01T00:00:00Z","image_size":"183292608","image_tags":["latest"],"ndv_containers":"0","num_fixes":"16","num_vulnerabilities_severity_1":"0","num_vulnerabilities_severity_2":"8","num_vulnerabilities_severity_3":"27","num_vulnerabilities_severity_4":"31","num_vulnerabilities_severity_5":"47","start_time":"2022-01-07T01:48:27.773Z"},{"eval_guid":"647f89e72bb00ce6b31a0767805d42f7","eval_status":"PASSED","eval_type":"EvalByAthena","image_created_time":"2021-11-30T04:03:28.378Z","image_digest":"sha256:4bed291aa5efb9f0d77b76ff7d4ab71eee410962965d052552db1fb80576431d","image_id":"sha256:3900abf4155226f3f62401054b872ce0c85b5c3b47275cae3d16a39c8646e36b","image_namespace":"","image_registry":"remote_scanner","image_repo":"redis","image_scan_error_msg":"[]","image_scan_status":"Success","image_scan_time":"1970-01-01T00:00:00Z","image_size":"32377896","image_tags":["alpine"],"ndv_containers":"0","num_fixes":"0","num_vulnerabilities_severity_1":"0","num_vulnerabilities_severity_2":"0","num_vulnerabilities_severity_3":"0","num_vulnerabilities_severity_4":"0","num_vulnerabilities_severity_5":"0","start_time":"2022-01-07T01:48:39.822Z"},{"eval_guid":"4119e4ad17e8e68452c21d673d6782cc","eval_status":"PASSED","eval_type":"EvalByAthena","image_created_time":"2021-10-06T00:05:06.77Z","image_digest":"sha256:9c92e73081a89569d6ac9b832b5f094e401d68d98bdf71d0fc54286ebaf88677","image_id":"sha256:4e27e7a3d69d7de0e3d23aa0b87a02f6bccc179f4200c7908c5fa96f91dc59b5","image_namespace":"","image_registry":"remote_scanner","image_repo":"example/resultsapp","image_scan_error_msg":"[]","image_scan_status":"Success","image_scan_time":"1970-01-01T00:00:00Z","image_size":"159316257","image_tags":["latest"],"ndv_containers":"0","num_fixes":"104","num_vulnerabilities_severity_1":"5","num_vulnerabilities_severity_2":"26","num_vulnerabilities_severity_3":"87","num_vulnerabilities_severity_4":"35","num_vulnerabilities_severity_5":"54","start_time":"2022-01-07T01:51:21.853Z"}],"ok":true,"message":"SUCCESS"}`

var rawContainerAssesment = `{"data":{"total_vulnerabilities":24,"critical_vulnerabilities":0,"high_vulnerabilities":0,"medium_vulnerabilities":3,"low_vulnerabilities":16,"info_vulnerabilities":5,"fixable_vulnerabilities":0,"last_evaluation_time":"2022-01-07T01:49:12.177Z","image":{"image_info":{"image_digest":"sha256:626ffe58f6e7566e00254b638eb7e0f3b11d4da9675088f4781a50ae288f3322","image_id":"sha256:ba6acccedd2923aee4c2acc6a23780b14ed4b8a5fa4e14e252a23b846df9b6c1","registry":"remote_scanner","repository":"ubuntu","created_time":"2021-10-16T00:37:47.578Z","size":72773644,"tags":["latest"]},"image_layers":[{"hash":"sha256:800bc5af689f6e976edc015154816444229bb7b68c40503d3d5b35df09fd5f7e","created_by":"ADD file:5d68d27cc15a80653c93d3a0b262a28112d47a46326ff5fc2dfbf7fa3b9a0ce8 in / ","packages":[{"name":"glibc","namescape":"","version":"2.31-0ubuntu9.2","vulnerabilities":[{"name":"CVE-2021-38604","description":"In librt in the GNU C Library (aka glibc) through 2.34, sysdeps/unix/sysv/linux/mq_notify.c mishandles certain NOTIFY_REMOVED data, leading to a NULL pointer dereference. NOTE: this vulnerability was introduced as a side effect of the CVE-2021-33574 fix.","severity":"medium","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2021-38604","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2021-08-12T16:15Z","Score":5,"Vectors":"AV:N/AC:L/Au:N/C:N/I:N/A:P"},"CVSSv3":{"ExploitabilityScore":3.9,"ImpactScore":3.6,"Score":7.5,"Vectors":"CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H"}}}},{"name":"CVE-2019-25013","description":"The iconv feature in the GNU C Library (aka glibc or libc6) through 2.32, when processing invalid multi-byte input sequences in the EUC-KR encoding, may have a buffer over-read.","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2019-25013","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2021-01-04T18:15Z","Score":7.1,"Vectors":"AV:N/AC:M/Au:N/C:N/I:N/A:C"},"CVSSv3":{"ExploitabilityScore":2.2,"ImpactScore":3.6,"Score":5.9,"Vectors":"CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H"}}}},{"name":"CVE-2020-6096","description":"An exploitable signed comparison vulnerability exists in the ARMv7 memcpy() implementation of GNU glibc 2.30.9000. Calling memcpy() (on ARMv7 targets that utilize the GNU glibc implementation) with a negative value for the 'num' parameter results in a signed comparison vulnerability. If an attacker underflows the 'num' parameter to memcpy(), this vulnerability could lead to undefined behavior such as writing to out-of-bounds memory and potentially remote code execution. Furthermore, this memcpy() implementation allows for program execution to continue in scenarios where a segmentation fault or crash should have occurred. The dangers occur in that subsequent execution and iterations of this code will be executed with this corrupted data.","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2020-6096","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2020-04-01T22:15Z","Score":6.8,"Vectors":"AV:N/AC:M/Au:N/C:P/I:P/A:P"},"CVSSv3":{"ExploitabilityScore":2.2,"ImpactScore":5.9,"Score":8.1,"Vectors":"CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H"}}}},{"name":"CVE-2021-3326","description":"The iconv function in the GNU C Library (aka glibc or libc6) 2.32 and earlier, when processing invalid input sequences in the ISO-2022-JP-3 encoding, fails an assertion in the code path and aborts the program, potentially resulting in a denial of service.","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2021-3326","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2021-01-27T20:15Z","Score":5,"Vectors":"AV:N/AC:L/Au:N/C:N/I:N/A:P"},"CVSSv3":{"ExploitabilityScore":3.9,"ImpactScore":3.6,"Score":7.5,"Vectors":"CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H"}}}},{"name":"CVE-2020-27618","description":"The iconv function in the GNU C Library (aka glibc or libc6) 2.32 and earlier, when processing invalid multi-byte input sequences in IBM1364, IBM1371, IBM1388, IBM1390, and IBM1399 encodings, fails to advance the input state, which could lead to an infinite loop in applications, resulting in a denial of service, a different vulnerability from CVE-2016-10228.","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2020-27618","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2021-02-26T23:15Z","Score":2.1,"Vectors":"AV:L/AC:L/Au:N/C:N/I:N/A:P"},"CVSSv3":{"ExploitabilityScore":1.8,"ImpactScore":3.6,"Score":5.5,"Vectors":"CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H"}}}},{"name":"CVE-2021-27645","description":"The nameserver caching daemon (nscd) in the GNU C Library (aka glibc or libc6) 2.29 through 2.33, when processing a request for netgroup lookup, may crash due to a double-free, potentially resulting in degraded service or Denial of Service on the local system. This is related to netgroupcache.c.","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2021-27645","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2021-02-24T15:15Z","Score":1.9,"Vectors":"AV:L/AC:M/Au:N/C:N/I:N/A:P"},"CVSSv3":{"ExploitabilityScore":1,"ImpactScore":1.4,"Score":2.5,"Vectors":"CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:L"}}}},{"name":"CVE-2018-20796","description":"In the GNU C Library (aka glibc or libc6) through 2.29, check_dst_limits_calc_pos_1 in posix/regexec.c has Uncontrolled Recursion, as demonstrated by '(\\\\\\\\227|)(\\\\\\\\\\\\\\\\1\\\\\\\\\\\\\\\\1|t1|\\\\\\\\\\\\\\\\\\\\\\\\2537)+' in grep.","severity":"info","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2018-20796","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2019-02-26T02:29Z","Score":5,"Vectors":"AV:N/AC:L/Au:N/C:N/I:N/A:P"},"CVSSv3":{"ExploitabilityScore":3.9,"ImpactScore":3.6,"Score":7.5,"Vectors":"CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H"}}}},{"name":"CVE-2021-35942","description":"The wordexp function in the GNU C Library (aka glibc) through 2.33 may crash or read arbitrary memory in parse_param (in posix/wordexp.c) when called with an untrusted, crafted pattern, potentially resulting in a denial of service or disclosure of information. This occurs because atoi was used but strtoul should have been used to ensure correct calculations.","severity":"medium","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2021-35942","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2021-07-22T18:15Z","Score":6.4,"Vectors":"AV:N/AC:L/Au:N/C:P/I:N/A:P"},"CVSSv3":{"ExploitabilityScore":3.9,"ImpactScore":5.2,"Score":9.1,"Vectors":"CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:H"}}}},{"name":"CVE-2016-10228","description":"The iconv program in the GNU C Library (aka glibc or libc6) 2.31 and earlier, when invoked with multiple suffixes in the destination encoding (TRANSLATE or IGNORE) along with the -c option, enters an infinite loop when processing invalid multi-byte input sequences, leading to a denial of service.","severity":"info","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2016-10228","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2017-03-02T01:59Z","Score":4.3,"Vectors":"AV:N/AC:M/Au:N/C:N/I:N/A:P"},"CVSSv3":{"ExploitabilityScore":2.2,"ImpactScore":3.6,"Score":5.9,"Vectors":"CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H"}}}},{"name":"CVE-2021-33574","description":"The mq_notify function in the GNU C Library (aka glibc) versions 2.32 and 2.33 has a use-after-free. It may use the notification thread attributes object (passed through its struct sigevent parameter) after it has been freed by the caller, leading to a denial of service (application crash) or possibly unspecified other impact.","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2021-33574","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2021-05-25T22:15Z","Score":7.5,"Vectors":"AV:N/AC:L/Au:N/C:P/I:P/A:P"},"CVSSv3":{"ExploitabilityScore":3.9,"ImpactScore":5.9,"Score":9.8,"Vectors":"CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"}}}},{"name":"CVE-2019-1010023","description":"** DISPUTED ** GNU Libc current is affected by: Re-mapping current loaded library with malicious ELF file. The impact is: In worst case attacker may evaluate privileges. The component is: libld. The attack vector is: Attacker sends 2 ELF files to victim and asks to run ldd on it. ldd execute code. NOTE: Upstream comments indicate \\\\this is being treated as a non-security bug and no real threat.\\\\","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2019-1010023","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2019-07-15T04:15Z","Score":6.8,"Vectors":"AV:N/AC:M/Au:N/C:P/I:P/A:P"},"CVSSv3":{"ExploitabilityScore":2.8,"ImpactScore":5.9,"Score":8.8,"Vectors":"CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H"}}}},{"name":"CVE-2019-1010024","description":"** DISPUTED ** GNU Libc current is affected by: Mitigation bypass. The impact is: Attacker may bypass ASLR using cache of thread stack and heap. The component is: glibc. NOTE: Upstream comments indicate \\\\this is being treated as a non-security bug and no real threat.\\\\","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2019-1010024","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2019-07-15T04:15Z","Score":5,"Vectors":"AV:N/AC:L/Au:N/C:P/I:N/A:N"},"CVSSv3":{"ExploitabilityScore":3.9,"ImpactScore":1.4,"Score":5.3,"Vectors":"CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N"}}}},{"name":"CVE-2020-29562","description":"The iconv function in the GNU C Library (aka glibc or libc6) 2.30 to 2.32, when converting UCS4 text containing an irreversible character, fails an assertion in the code path and aborts the program, potentially resulting in a denial of service.","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2020-29562","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2020-12-04T07:15Z","Score":2.1,"Vectors":"AV:N/AC:H/Au:S/C:N/I:N/A:P"},"CVSSv3":{"ExploitabilityScore":1.2,"ImpactScore":3.6,"Score":4.8,"Vectors":"CVSS:3.0/AV:N/AC:H/PR:L/UI:R/S:U/C:N/I:N/A:H"}}}},{"name":"CVE-2019-1010022","description":"** DISPUTED ** GNU Libc current is affected by: Mitigation bypass. The impact is: Attacker may bypass stack guard protection. The component is: nptl. The attack vector is: Exploit stack buffer overflow vulnerability and use this bypass vulnerability to bypass stack guard. NOTE: Upstream comments indicate \\\\this is being treated as a non-security bug and no real threat.\\\\","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2019-1010022","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2019-07-15T04:15Z","Score":7.5,"Vectors":"AV:N/AC:L/Au:N/C:P/I:P/A:P"},"CVSSv3":{"ExploitabilityScore":3.9,"ImpactScore":5.9,"Score":9.8,"Vectors":"CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"}}}}]},{"name":"pcre3","namescape":"","version":"2:8.39-12build1","vulnerabilities":[{"name":"CVE-2017-11164","description":"In PCRE 8.41, the OP_KETRMAX feature in the match function in pcre_exec.c allows stack exhaustion (uncontrolled recursion) when processing a crafted regular expression.","severity":"info","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2017-11164","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2017-07-11T03:29Z","Score":7.8,"Vectors":"AV:N/AC:L/Au:N/C:N/I:N/A:C"},"CVSSv3":{"ExploitabilityScore":3.9,"ImpactScore":3.6,"Score":7.5,"Vectors":"CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H"}}}},{"name":"CVE-2020-14155","description":"libpcre in PCRE before 8.44 allows an integer overflow via a large number after a (?C substring.","severity":"info","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2020-14155","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2020-06-15T17:15Z","Score":5,"Vectors":"AV:N/AC:L/Au:N/C:N/I:N/A:P"},"CVSSv3":{"ExploitabilityScore":3.9,"ImpactScore":1.4,"Score":5.3,"Vectors":"CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:L"}}}},{"name":"CVE-2019-20838","description":"libpcre in PCRE before 8.43 allows a subject buffer over-read in JIT when UTF is disabled, and \\\\\\\\X or \\\\\\\\R has more than one fixed quantifier, a related issue to CVE-2019-20454.","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2019-20838","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2020-06-15T17:15Z","Score":4.3,"Vectors":"AV:N/AC:M/Au:N/C:N/I:N/A:P"},"CVSSv3":{"ExploitabilityScore":3.9,"ImpactScore":3.6,"Score":7.5,"Vectors":"CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H"}}}}]},{"name":"bash","namescape":"","version":"5.0-6ubuntu1.1","vulnerabilities":[{"name":"CVE-2019-18276","description":"An issue was discovered in disable_priv_mode in shell.c in GNU Bash through 5.0 patch 11. By default, if Bash is run with its effective UID not equal to its real UID, it will drop privileges by setting its effective UID to its real UID. However, it does so incorrectly. On Linux and other systems that support \\\\saved UID\\\\ functionality, the saved UID is not dropped. An attacker with command execution in the shell can use \\\\enable -f\\\\ for runtime loading of a new builtin, which can be a shared object that calls setuid() and therefore regains privileges. However, binaries running with an effective UID of 0 are unaffected.","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2019-18276","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2019-11-28T01:15Z","Score":7.2,"Vectors":"AV:L/AC:L/Au:N/C:C/I:C/A:C"},"CVSSv3":{"ExploitabilityScore":1.8,"ImpactScore":5.9,"Score":7.8,"Vectors":"CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H"}}}}]},{"name":"shadow","namescape":"","version":"1:4.8.1-1ubuntu5.20.04.1","vulnerabilities":[{"name":"CVE-2013-4235","description":"shadow: TOCTOU (time-of-check time-of-use) race condition when copying and removing directory trees","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2013-4235","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2019-12-03T15:15Z","Score":3.3,"Vectors":"AV:L/AC:M/Au:N/C:N/I:P/A:P"},"CVSSv3":{"ExploitabilityScore":1,"ImpactScore":3.6,"Score":4.7,"Vectors":"CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:H/A:N"}}}}]},{"name":"systemd","namescape":"","version":"245.4-4ubuntu3.13","vulnerabilities":[{"name":"CVE-2020-13776","description":"systemd through v245 mishandles numerical usernames such as ones composed of decimal digits or 0x followed by hex digits, as demonstrated by use of root privileges when privileges of the 0x0 user account were intended. NOTE: this issue exists because of an incomplete fix for CVE-2017-1000082.","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2020-13776","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2020-06-03T03:15Z","Score":6.2,"Vectors":"AV:L/AC:H/Au:N/C:C/I:C/A:C"},"CVSSv3":{"ExploitabilityScore":0.8,"ImpactScore":5.9,"Score":6.7,"Vectors":"CVSS:3.0/AV:L/AC:H/PR:L/UI:R/S:U/C:H/I:H/A:H"}}}}]},{"name":"libtasn1-6","namescape":"","version":"4.16.0-2","vulnerabilities":[{"name":"CVE-2018-1000654","description":"GNU Libtasn1-4.13 libtasn1-4.13 version libtasn1-4.13, libtasn1-4.12 contains a DoS, specifically CPU usage will reach 100% when running asn1Paser against the POC due to an issue in _asn1_expand_object_id(p_tree), after a long time, the program will be killed. This attack appears to be exploitable via parsing a crafted file.","severity":"info","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2018-1000654","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2018-08-20T19:31Z","Score":7.1,"Vectors":"AV:N/AC:M/Au:N/C:N/I:N/A:C"},"CVSSv3":{"ExploitabilityScore":1.8,"ImpactScore":3.6,"Score":5.5,"Vectors":"CVSS:3.0/AV:L/AC:L/PR:N/UI:R/S:U/C:N/I:N/A:H"}}}}]},{"name":"coreutils","namescape":"","version":"8.30-3ubuntu2","vulnerabilities":[{"name":"CVE-2016-2781","description":"chroot in GNU coreutils, when used with --userspec, allows local users to escape to the parent session via a crafted TIOCSTI ioctl call, which pushes characters to the terminal's input buffer.","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2016-2781","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2017-02-07T15:59Z","Score":2.1,"Vectors":"AV:L/AC:L/Au:N/C:N/I:P/A:N"},"CVSSv3":{"ExploitabilityScore":2,"ImpactScore":4,"Score":6.5,"Vectors":"CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:C/C:N/I:H/A:N"}}}}]},{"name":"perl","namescape":"","version":"5.30.0-9ubuntu0.2","vulnerabilities":[{"name":"CVE-2020-16156","description":"CPAN 2.28 allows Signature Verification Bypass.","severity":"medium","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2020-16156","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2021-12-13T18:15Z","Score":6.8,"Vectors":"AV:N/AC:M/Au:N/C:P/I:P/A:P"},"CVSSv3":{"ExploitabilityScore":1.8,"ImpactScore":5.9,"Score":7.8,"Vectors":"CVSS:3.0/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H"}}}}]},{"name":"gmp","namescape":"","version":"2:6.2.0+dfsg-4","vulnerabilities":[{"name":"CVE-2021-43618","description":"GNU Multiple Precision Arithmetic Library (GMP) through 6.2.1 has an mpz/inp_raw.c integer overflow and resultant buffer overflow via crafted input, leading to a segmentation fault on 32-bit platforms.","severity":"low","link":"http://people.ubuntu.com/~ubuntu-security/cve/CVE-2021-43618","fix_version":"","metadata":{"NVD":{"CVSSv2":{"PublishedDateTime":"2021-11-15T04:15Z","Score":5,"Vectors":"AV:N/AC:L/Au:N/C:N/I:N/A:P"},"CVSSv3":{"ExploitabilityScore":3.9,"ImpactScore":3.6,"Score":7.5,"Vectors":"CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H"}}}}]}]}]},"scan_status":"Success"},"ok":true,"message":"SUCCESS"}`
