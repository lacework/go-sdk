//
// Author:: Salim Afiune Maya (<afiune@lacework.net>)
// Copyright:: Copyright 2021, Lacework Inc.
// License:: Apache License, Version 2.0
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//

package cmd

import (
	"encoding/json"
	"log"
	"strings"
	"testing"

	"github.com/stretchr/testify/assert"

	"github.com/lacework/go-sdk/api"
)

func TestBuildVulnContainerAssessmentReportsNoVulnerabilities(t *testing.T) {
	cliOutput := captureOutput(func() {
		assert.Nil(t, buildVulnContainerAssessmentReports(new(api.VulnContainerAssessment)))
	})
	assert.Contains(t, cliOutput, "Great news! This container image has no vulnerabilities...")

	t.Run("test JSON output", func(t *testing.T) {
		cli.EnableJSONOutput()
		defer cli.EnableHumanOutput()
		cliJSONOutput := captureOutput(func() {
			assert.Nil(t, buildVulnContainerAssessmentReports(new(api.VulnContainerAssessment)))
		})
		expectedJSON := `{
  "critical_vulnerabilities": 0,
  "fixable_vulnerabilities": 0,
  "high_vulnerabilities": 0,
  "info_vulnerabilities": 0,
  "low_vulnerabilities": 0,
  "medium_vulnerabilities": 0,
  "total_vulnerabilities": 0
}
`
		assert.Equal(t, expectedJSON, cliJSONOutput)
	})
}

func TestBuildVulnContainerAssessmentReportsWithVulnerabilitiesButNoImageInformation(t *testing.T) {
	cliOutput := captureOutput(func() {
		err := buildVulnContainerAssessmentReports(&api.VulnContainerAssessment{TotalVulnerabilities: 10})
		if assert.NotNil(t, err, "we would panic, please check this error") {
			assert.Equal(t, "unable to build container vulnerability report. (image information not found)", err.Error())
		}
	})
	assert.Empty(t, cliOutput)
}

func TestBuildVulnContainerAssessmentReportsWithVulnerabilitiesPackagesView(t *testing.T) {
	vulCmdState.Packages = true
	defer clearVulnFilters()

	cliOutput := captureOutput(func() {
		assert.Nil(t, buildVulnContainerAssessmentReports(mockVulnerabilityAssessment()))
	})
	// NOTE (@afiune): We purposly leave trailing spaces in this table, we need them!
	expectedTable := `
                                  CONTAINER IMAGE DETAILS                                          VULNERABILITIES          
------------------------------------------------------------------------------------------+---------------------------------
    ID          sha256:6446ea57df7b5badfcbdb47cf2d05d7831a33d36a97835b2c061cd1b4cc33deb       SEVERITY   COUNT   FIXABLE    
    Digest      sha256:c933030694d7c95a266f8ba1236711595065b10531dd0df655852bccce96a66e     -----------+-------+----------  
    Registry    index.docker.io                                                               Critical       1         1    
    Repository  techallylw/test-cli-clean                                                     High           2         2    
    Size        2.7 MB                                                                        Medium         1         1    
    Created At  2020-05-29T21:19:46.363Z                                                      Low            0         0    
    Tags        latest                                                                        Info           0         0    
                                                                                                                            
  CVE COUNT   SEVERITY    PACKAGE    CURRENT VERSION   FIX VERSION  
------------+----------+-----------+-----------------+--------------
  1           Critical   apk-tools   2.10.5-r1         2.10.7-r0    
  1           High       apk-tools   2.10.5-r1         2.10.6-r0    
  1           High       busybox     1.31.1-r16        1.31.1-r20   
  1           Medium     musl        1.1.24-r8         1.1.24-r10   
`
	assert.Equal(t, strings.TrimPrefix(expectedTable, "\n"), cliOutput)
}

func TestBuildVulnContainerAssessmentReportsWithVulnerabilitiesPackagesViewWithFilters(t *testing.T) {
	vulCmdState.Severity = "critical"
	vulCmdState.Packages = true
	defer clearVulnFilters()

	cliOutput := captureOutput(func() {
		assert.Nil(t, buildVulnContainerAssessmentReports(mockVulnerabilityAssessment()))
	})
	// NOTE (@afiune): We purposly leave trailing spaces in this table, we need them!
	expectedTable := `
                                  CONTAINER IMAGE DETAILS                                          VULNERABILITIES          
------------------------------------------------------------------------------------------+---------------------------------
    ID          sha256:6446ea57df7b5badfcbdb47cf2d05d7831a33d36a97835b2c061cd1b4cc33deb       SEVERITY   COUNT   FIXABLE    
    Digest      sha256:c933030694d7c95a266f8ba1236711595065b10531dd0df655852bccce96a66e     -----------+-------+----------  
    Registry    index.docker.io                                                               Critical       1         1    
    Repository  techallylw/test-cli-clean                                                     High           2         2    
    Size        2.7 MB                                                                        Medium         1         1    
    Created At  2020-05-29T21:19:46.363Z                                                      Low            0         0    
    Tags        latest                                                                        Info           0         0    
                                                                                                                            
  CVE COUNT   SEVERITY    PACKAGE    CURRENT VERSION   FIX VERSION  
------------+----------+-----------+-----------------+--------------
  1           Critical   apk-tools   2.10.5-r1         2.10.7-r0    
1 of 4 packages showing 
`
	assert.Equal(t, strings.TrimPrefix(expectedTable, "\n"), cliOutput)

	t.Run("test JSON output", func(t *testing.T) {
		cli.EnableJSONOutput()
		defer cli.EnableHumanOutput()
		cliJSONOutput := captureOutput(func() {
			assert.Nil(t, buildVulnContainerAssessmentReports(mockVulnerabilityAssessment()))
		})
		expectedJSON := `{
  "critical_vulnerabilities": 1,
  "fixable_vulnerabilities": 4,
  "high_vulnerabilities": 2,
  "image": {
    "image_info": {
      "created_time": "2020-05-29T21:19:46.363Z",
      "image_digest": "sha256:c933030694d7c95a266f8ba1236711595065b10531dd0df655852bccce96a66e",
      "image_id": "sha256:6446ea57df7b5badfcbdb47cf2d05d7831a33d36a97835b2c061cd1b4cc33deb",
      "registry": "index.docker.io",
      "repository": "techallylw/test-cli-clean",
      "size": 2797541,
      "tags": [
        "latest"
      ]
    },
    "image_layers": [
      {
        "created_by": "ADD file:c92c248239f8c7b9b3c067650954815f391b7bcb09023f984972c082ace2a8d0 in / ",
        "hash": "sha256:sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c",
        "packages": [
          {
            "name": "apk-tools",
            "namescape": "",
            "version": "2.10.5-r1",
            "vulnerabilities": [
              {
                "description": "",
                "fix_version": "2.10.7-r0",
                "link": "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-36159",
                "metadata": {
                  "NVD": {
                    "CVSSv2": {
                      "PublishedDateTime": "2021-08-03T14:15Z",
                      "Score": 6.4,
                      "Vectors": "AV:N/AC:L/Au:N/C:P/I:N/A:P"
                    },
                    "CVSSv3": {
                      "ExploitabilityScore": 3.9,
                      "ImpactScore": 5.2,
                      "Score": 9.1,
                      "Vectors": "CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:H"
                    }
                  }
                },
                "name": "CVE-2021-36159",
                "severity": "critical"
              }
            ]
          }
        ]
      }
    ]
  },
  "info_vulnerabilities": 0,
  "last_evaluation_time": "2021-11-05T12:47:03.886Z",
  "low_vulnerabilities": 0,
  "medium_vulnerabilities": 1,
  "scan_status": "Success",
  "total_vulnerabilities": 4
}
`
		assert.Equal(t, expectedJSON, cliJSONOutput)
	})
}

func mockVulnerabilityAssessment() *api.VulnContainerAssessment {
	assessment := &api.VulnContainerAssessment{}
	err := json.Unmarshal([]byte(`{
  "critical_vulnerabilities": 1,
  "fixable_vulnerabilities": 4,
  "high_vulnerabilities": 2,
  "image": {
    "image_info": {
      "created_time": "2020-05-29T21:19:46.363Z",
      "image_digest": "sha256:c933030694d7c95a266f8ba1236711595065b10531dd0df655852bccce96a66e",
      "image_id": "sha256:6446ea57df7b5badfcbdb47cf2d05d7831a33d36a97835b2c061cd1b4cc33deb",
      "registry": "index.docker.io",
      "repository": "techallylw/test-cli-clean",
      "size": 2797541,
      "tags": [
        "latest"
      ]
    },
    "image_layers": [
      {
        "created_by": "ADD file:c92c248239f8c7b9b3c067650954815f391b7bcb09023f984972c082ace2a8d0 in / ",
        "hash": "sha256:sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c",
        "packages": [
          {
            "name": "apk-tools",
            "namescape": "",
            "version": "2.10.5-r1",
            "vulnerabilities": [
              {
                "description": "",
                "fix_version": "2.10.6-r0",
                "link": "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-30139",
                "metadata": {
                  "NVD": {
                    "CVSSv2": {
                      "PublishedDateTime": "2021-04-21T16:15Z",
                      "Score": 5,
                      "Vectors": "AV:N/AC:L/Au:N/C:N/I:N/A:P"
                    },
                    "CVSSv3": {
                      "ExploitabilityScore": 3.9,
                      "ImpactScore": 3.6,
                      "Score": 7.5,
                      "Vectors": "CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H"
                    }
                  }
                },
                "name": "CVE-2021-30139",
                "severity": "high"
              },
              {
                "description": "",
                "fix_version": "2.10.7-r0",
                "link": "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-36159",
                "metadata": {
                  "NVD": {
                    "CVSSv2": {
                      "PublishedDateTime": "2021-08-03T14:15Z",
                      "Score": 6.4,
                      "Vectors": "AV:N/AC:L/Au:N/C:P/I:N/A:P"
                    },
                    "CVSSv3": {
                      "ExploitabilityScore": 3.9,
                      "ImpactScore": 5.2,
                      "Score": 9.1,
                      "Vectors": "CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:H"
                    }
                  }
                },
                "name": "CVE-2021-36159",
                "severity": "critical"
              }
            ]
          },
          {
            "name": "musl",
            "namescape": "",
            "version": "1.1.24-r8",
            "vulnerabilities": [
              {
                "description": "",
                "fix_version": "1.1.24-r10",
                "link": "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-28928",
                "metadata": {
                  "NVD": {
                    "CVSSv2": {
                      "PublishedDateTime": "2020-11-24T18:15Z",
                      "Score": 2.1,
                      "Vectors": "AV:L/AC:L/Au:N/C:N/I:N/A:P"
                    },
                    "CVSSv3": {
                      "ExploitabilityScore": 1.8,
                      "ImpactScore": 3.6,
                      "Score": 5.5,
                      "Vectors": "CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H"
                    }
                  }
                },
                "name": "CVE-2020-28928",
                "severity": "medium"
              }
            ]
          },
          {
            "name": "busybox",
            "namescape": "",
            "version": "1.31.1-r16",
            "vulnerabilities": [
              {
                "description": "",
                "fix_version": "1.31.1-r20",
                "link": "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-28831",
                "metadata": {
                  "NVD": {
                    "CVSSv2": {
                      "PublishedDateTime": "2021-03-19T05:15Z",
                      "Score": 5,
                      "Vectors": "AV:N/AC:L/Au:N/C:N/I:N/A:P"
                    },
                    "CVSSv3": {
                      "ExploitabilityScore": 3.9,
                      "ImpactScore": 3.6,
                      "Score": 7.5,
                      "Vectors": "CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H"
                    }
                  }
                },
                "name": "CVE-2021-28831",
                "severity": "high"
              }
            ]
          }
        ]
      }
    ]
  },
  "info_vulnerabilities": 0,
  "last_evaluation_time": "2021-11-05T12:47:03.886Z",
  "low_vulnerabilities": 0,
  "medium_vulnerabilities": 1,
  "scan_status": "Success",
  "total_vulnerabilities": 4
}`), assessment)
	if err != nil {
		log.Fatal(err)
	}
	return assessment
}
