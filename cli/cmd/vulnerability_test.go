//
// Author:: Salim Afiune Maya (<afiune@lacework.net>)
// Copyright:: Copyright 2021, Lacework Inc.
// License:: Apache License, Version 2.0
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//

package cmd

import (
	"encoding/json"
	"log"
	"strings"
	"testing"

	"github.com/stretchr/testify/assert"

	"github.com/lacework/go-sdk/api"
	"github.com/lacework/go-sdk/internal/capturer"
)

func TestBuildVulnContainerAssessmentReportsNoVulnerabilities(t *testing.T) {
	cliOutput := capturer.CaptureOutput(func() {
		assert.Nil(t, buildVulnContainerAssessmentReports(api.VulnerabilitiesContainersResponse{}))
	})
	assert.Contains(t, cliOutput, "Great news! This container image has no vulnerabilities...")

	t.Run("test JSON output", func(t *testing.T) {
		cli.EnableJSONOutput()
		defer cli.EnableHumanOutput()
		cliJSONOutput := capturer.CaptureOutput(func() {
			assert.Nil(t, buildVulnContainerAssessmentReports(api.VulnerabilitiesContainersResponse{}))
		})
		expectedJSON := `[]
`
		assert.Equal(t, expectedJSON, cliJSONOutput)
	})
}

func TestBuildVulnContainerAssessmentReportsWithVulnerabilitiesPackagesView(t *testing.T) {
	vulCmdState.Packages = true
	defer clearVulnFilters()

	cliOutput := capturer.CaptureOutput(func() {
		assert.Nil(t, buildVulnContainerAssessmentReports(mockVulnerabilityAssessment()))
	})
	// NOTE (@afiune): We purposely leave trailing spaces in this table, we need them!
	expectedTable := `                                  CONTAINER IMAGE DETAILS                                           VULNERABILITIES          
-------------------------------------------------------------------------------------------+---------------------------------
    ID          sha256:123d12a1238613e123456ab1c1141441e6850dbab1416abcd7d675cfb34412abc       SEVERITY   COUNT   FIXABLE    
    Digest      sha256:1234ab1cd12345ab91d8cf9848682b12c5ce64c208e8f796542410d1abcderg       -----------+-------+----------  
    Registry    gcr.io                                                                         Critical       1         1    
    Repository  techally-test-123/test                                                         High           0         0    
    Size        19.9 MB                                                                        Medium         1         1    
    Created At  2020-04-30T23:18:40+01:00                                                      Low            0         0    
    Tags        v0.1.0-00-abc                                                                  Info           0         0    
                                                                                                                             
  CVE COUNT   SEVERITY    PACKAGE    CURRENT VERSION   FIX VERSION  
------------+----------+-----------+-----------------+--------------
  1           Critical   example-2   1.00.0-r1         1.20.00-r0   
  1           Medium     example     1.00.0-r1         1.20.00-r0   
`
	assert.Equal(t, strings.TrimPrefix(expectedTable, "\n"), cliOutput)
}

func TestBuildVulnContainerAssessmentReportsWithVulnerabilitiesPackagesViewWithFilters(t *testing.T) {
	vulCmdState.Severity = "critical"
	vulCmdState.Packages = true
	defer clearVulnFilters()

	cliOutput := capturer.CaptureOutput(func() {
		assert.Nil(t, buildVulnContainerAssessmentReports(mockVulnerabilityAssessment()))
	})
	// NOTE (@afiune): We purposely leave trailing spaces in this table, we need them!
	expectedTable := `
                                  CONTAINER IMAGE DETAILS                                           VULNERABILITIES          
-------------------------------------------------------------------------------------------+---------------------------------
    ID          sha256:123d12a1238613e123456ab1c1141441e6850dbab1416abcd7d675cfb34412abc       SEVERITY   COUNT   FIXABLE    
    Digest      sha256:1234ab1cd12345ab91d8cf9848682b12c5ce64c208e8f796542410d1abcderg       -----------+-------+----------  
    Registry    gcr.io                                                                         Critical       1         1    
    Repository  techally-test-123/test                                                         High           0         0    
    Size        19.9 MB                                                                        Medium         0         0    
    Created At  2020-04-30T23:18:40+01:00                                                      Low            0         0    
    Tags        v0.1.0-00-abc                                                                  Info           0         0    
                                                                                                                             
  CVE COUNT   SEVERITY    PACKAGE    CURRENT VERSION   FIX VERSION  
------------+----------+-----------+-----------------+--------------
  1           Critical   example-2   1.00.0-r1         1.20.00-r0   
1 of 1 packages showing 
`
	assert.Equal(t, strings.TrimPrefix(expectedTable, "\n"), cliOutput)

	t.Run("test JSON output", func(t *testing.T) {
		cli.EnableJSONOutput()
		defer cli.EnableHumanOutput()
		cliJSONOutput := capturer.CaptureOutput(func() {
			assert.Nil(t, buildVulnContainerAssessmentReports(mockVulnerabilityAssessment()))
		})
		expectedJSON := `[
  {
    [36;1m"evalCtx"[0m: {
      [36;1m"cve_batch_info"[0m: [
        {
          [36;1m"cve_batch_id"[0m: [32;1m""[0m,
          [36;1m"cve_created_time"[0m: [32;1m"2022-11-14 00:07:45.736000000"[0m
        }
      ],
      [36;1m"exception_props"[0m: [37;1mnull[0m,
      [36;1m"image_info"[0m: {
        [36;1m"created_time"[0m: [31;1m1588285120631[0m,
        [36;1m"digest"[0m: [32;1m"sha256:1234ab1cd12345ab91d8cf9848682b12c5ce64c208e8f796542410d1abcderg"[0m,
        [36;1m"error_msg"[0m: [37;1mnull[0m,
        [36;1m"id"[0m: [32;1m"sha256:123d12a1238613e123456ab1c1141441e6850dbab1416abcd7d675cfb34412abc"[0m,
        [36;1m"registry"[0m: [32;1m"gcr.io"[0m,
        [36;1m"repo"[0m: [32;1m"techally-test-123/test"[0m,
        [36;1m"size"[0m: [31;1m20853835[0m,
        [36;1m"status"[0m: [32;1m"Success"[0m,
        [36;1m"tags"[0m: [
          [32;1m"v0.1.0-00-abc"[0m
        ],
        [36;1m"type"[0m: [32;1m"Docker"[0m
      },
      [36;1m"isDailyJob"[0m: [32;1m""[0m,
      [36;1m"is_reeval"[0m: [33;1mtrue[0m,
      [36;1m"scan_batch_id"[0m: [32;1m"a1234546-a6a3-4509-a1e9-123283a1020e-1636768866551654123"[0m,
      [36;1m"scan_created_time"[0m: [32;1m""[0m,
      [36;1m"scan_request_props"[0m: {
        [36;1m"data_format_version"[0m: [32;1m"1.0"[0m,
        [36;1m"environment"[0m: {
          [36;1m"docker_version"[0m: {
            [36;1m"error_message"[0m: [32;1m""[0m
          }
        },
        [36;1m"props"[0m: {
          [36;1m"data_format_version"[0m: [32;1m"1.0"[0m,
          [36;1m"scanner_version"[0m: [32;1m"0.1.0"[0m
        },
        [36;1m"scanCompletionUtcTime"[0m: [31;1m1636768866[0m,
        [36;1m"scan_start_time"[0m: [31;1m1636768865[0m,
        [36;1m"scanner_version"[0m: [32;1m"0.2.2"[0m
      },
      [36;1m"vuln_batch_id"[0m: [32;1m"ABCD1A1234AB123A1AB12AB1BD867B123"[0m,
      [36;1m"vuln_created_time"[0m: [32;1m"2022-11-14 00:07:45.736000000"[0m
    },
    [36;1m"featureKey"[0m: {
      [36;1m"name"[0m: [32;1m"example"[0m,
      [36;1m"namespace"[0m: [32;1m"alpine:test"[0m,
      [36;1m"version"[0m: [32;1m"1.00.0-r1"[0m
    },
    [36;1m"featureProps"[0m: {
      [36;1m"feed"[0m: [32;1m"lacework"[0m,
      [36;1m"introduced_in"[0m: [32;1m"example"[0m,
      [36;1m"layer"[0m: [32;1m"sha256:sha256:1234d8c89e19b4b4abcdd4af13d64150ba3d482445d820ae1f6ba71ed6812345"[0m,
      [36;1m"src"[0m: [32;1m""[0m,
      [36;1m"version_format"[0m: [32;1m"apk"[0m
    },
    [36;1m"fixInfo"[0m: {
      [36;1m"compare_result"[0m: [31;1m0[0m,
      [36;1m"fix_available"[0m: [31;1m1[0m,
      [36;1m"fixed_version"[0m: [32;1m"1.20.00-r0"[0m
    },
    [36;1m"imageId"[0m: [32;1m"sha256:123d67f5861237689554fa4a2121441e1230dbab9416fccd7d675cfb34476abcd"[0m,
    [36;1m"severity"[0m: [32;1m"Medium"[0m,
    [36;1m"startTime"[0m: [32;1m"2022-11-14T00:20:57.367Z"[0m,
    [36;1m"status"[0m: [32;1m"VULNERABLE"[0m,
    [36;1m"vulnId"[0m: [32;1m"CVE-2021-24215"[0m
  },
  {
    [36;1m"evalCtx"[0m: {
      [36;1m"cve_batch_info"[0m: [
        {
          [36;1m"cve_batch_id"[0m: [32;1m""[0m,
          [36;1m"cve_created_time"[0m: [32;1m"2022-11-14 00:07:45.736000000"[0m
        }
      ],
      [36;1m"exception_props"[0m: [37;1mnull[0m,
      [36;1m"image_info"[0m: {
        [36;1m"created_time"[0m: [31;1m1588285120631[0m,
        [36;1m"digest"[0m: [32;1m"sha256:1234ab1cd12345ab91d8cf9848682b12c5ce64c208e8f796542410d1abcderg"[0m,
        [36;1m"error_msg"[0m: [37;1mnull[0m,
        [36;1m"id"[0m: [32;1m"sha256:123d12a1238613e123456ab1c1141441e6850dbab1416abcd7d675cfb34412abc"[0m,
        [36;1m"registry"[0m: [32;1m"gcr.io"[0m,
        [36;1m"repo"[0m: [32;1m"techally-test-123/test"[0m,
        [36;1m"size"[0m: [31;1m20853835[0m,
        [36;1m"status"[0m: [32;1m"Success"[0m,
        [36;1m"tags"[0m: [
          [32;1m"v0.1.0-00-abc"[0m
        ],
        [36;1m"type"[0m: [32;1m"Docker"[0m
      },
      [36;1m"isDailyJob"[0m: [32;1m""[0m,
      [36;1m"is_reeval"[0m: [33;1mtrue[0m,
      [36;1m"scan_batch_id"[0m: [32;1m"a1234546-a6a3-4509-a1e9-123283a1020e-1636768866551654123"[0m,
      [36;1m"scan_created_time"[0m: [32;1m""[0m,
      [36;1m"scan_request_props"[0m: {
        [36;1m"data_format_version"[0m: [32;1m"1.0"[0m,
        [36;1m"environment"[0m: {
          [36;1m"docker_version"[0m: {
            [36;1m"error_message"[0m: [32;1m""[0m
          }
        },
        [36;1m"props"[0m: {
          [36;1m"data_format_version"[0m: [32;1m"1.0"[0m,
          [36;1m"scanner_version"[0m: [32;1m"0.1.0"[0m
        },
        [36;1m"scanCompletionUtcTime"[0m: [31;1m1636768866[0m,
        [36;1m"scan_start_time"[0m: [31;1m1636768865[0m,
        [36;1m"scanner_version"[0m: [32;1m"0.2.2"[0m
      },
      [36;1m"vuln_batch_id"[0m: [32;1m"ABCD1A1234AB123A1AB12AB1BD867B123"[0m,
      [36;1m"vuln_created_time"[0m: [32;1m"2022-11-14 00:07:45.736000000"[0m
    },
    [36;1m"featureKey"[0m: {
      [36;1m"name"[0m: [32;1m"example-2"[0m,
      [36;1m"namespace"[0m: [32;1m"alpine:test"[0m,
      [36;1m"version"[0m: [32;1m"1.00.0-r1"[0m
    },
    [36;1m"featureProps"[0m: {
      [36;1m"feed"[0m: [32;1m"lacework"[0m,
      [36;1m"introduced_in"[0m: [32;1m"example introduced"[0m,
      [36;1m"layer"[0m: [32;1m"sha256:sha256:1234d8c89e19b4b4abcdd4af13d64150ba3d482445d820ae1f6ba71ed6812345"[0m,
      [36;1m"src"[0m: [32;1m""[0m,
      [36;1m"version_format"[0m: [32;1m"apk"[0m
    },
    [36;1m"fixInfo"[0m: {
      [36;1m"compare_result"[0m: [31;1m0[0m,
      [36;1m"fix_available"[0m: [31;1m1[0m,
      [36;1m"fixed_version"[0m: [32;1m"1.20.00-r0"[0m
    },
    [36;1m"imageId"[0m: [32;1m"sha256:123d67f5861237689554fa4a2121441e1230dbab9416fccd7d675cfb34476abcd"[0m,
    [36;1m"severity"[0m: [32;1m"Critical"[0m,
    [36;1m"startTime"[0m: [32;1m"2022-11-14T00:20:57.367Z"[0m,
    [36;1m"status"[0m: [32;1m"VULNERABLE"[0m,
    [36;1m"vulnId"[0m: [32;1m"CVE-2020-24215"[0m
  }
]
`
		assert.Equal(t, expectedJSON, cliJSONOutput)
	})
}

func mockVulnerabilityAssessment() api.VulnerabilitiesContainersResponse {
	var assessment api.VulnerabilitiesContainersResponse
	err := json.Unmarshal([]byte(`{
    "paging": {
        "rows": 1,
        "totalRows": 1,
        "urls": {
            "nextPage": null
        }
    },
    "data": [
        {
            "evalCtx": {
                "cve_batch_info": [
                    {
                        "cve_created_time": "2022-11-14 00:07:45.736000000"
                    }
                ],
                "image_info": {
                    "created_time": 1588285120631,
                    "digest": "sha256:1234ab1cd12345ab91d8cf9848682b12c5ce64c208e8f796542410d1abcderg",
                    "id": "sha256:123d12a1238613e123456ab1c1141441e6850dbab1416abcd7d675cfb34412abc",
                    "registry": "gcr.io",
                    "repo": "techally-test-123/test",
                    "scan_created_time": 1636768865,
                    "size": 20853835,
                    "status": "Success",
                    "tags": [
                        "v0.1.0-00-abc"
                    ],
                    "type": "Docker"
                },
                "integration_props": {},
                "is_reeval": true,
                "request_source": "PLATFORM_SCANNER",
                "scan_batch_id": "a1234546-a6a3-4509-a1e9-123283a1020e-1636768866551654123",
                "scan_request_props": {
                    "data_format_version": "1.0",
                    "props": {
                        "data_format_version": "1.0",
                        "scanner_version": "0.1.0"
                    },
                    "scanCompletionUtcTime": 1636768866,
                    "scan_start_time": 1636768865,
                    "scanner_version": "0.2.2"
                },
                "vuln_batch_id": "ABCD1A1234AB123A1AB12AB1BD867B123",
                "vuln_created_time": "2022-11-14 00:07:45.736000000"
            },
            "evalGuid": "0a1234567891a1230f2a12a0a12b12ab",
            "featureKey": {
                "name": "example",
                "namespace": "alpine:test",
                "version": "1.00.0-r1"
            },
            "featureProps": {
                "feed": "lacework",
                "introduced_in": "example",
                "layer": "sha256:sha256:1234d8c89e19b4b4abcdd4af13d64150ba3d482445d820ae1f6ba71ed6812345",
                "src": "",
                "version_format": "apk"
            },
            "fixInfo": {
                "fix_available": 1,
                "fixed_version": "1.20.00-r0"
            },
            "imageId": "sha256:123d67f5861237689554fa4a2121441e1230dbab9416fccd7d675cfb34476abcd",
            "severity": "Medium",
            "startTime": "2022-11-14T00:20:57.367Z",
            "status": "VULNERABLE",
            "vulnId": "CVE-2021-24215"
        },
        {
            "evalCtx": {
                "cve_batch_info": [
                    {
                        "cve_created_time": "2022-11-14 00:07:45.736000000"
                    }
                ],
                "image_info": {
                    "created_time": 1588285120631,
                    "digest": "sha256:1234ab1cd12345ab91d8cf9848682b12c5ce64c208e8f796542410d1abcderg",
                    "id": "sha256:123d12a1238613e123456ab1c1141441e6850dbab1416abcd7d675cfb34412abc",
                    "registry": "gcr.io",
                    "repo": "techally-test-123/test",
                    "scan_created_time": 1636768865,
                    "size": 20853835,
                    "status": "Success",
                    "tags": [
                        "v0.1.0-00-abc"
                    ],
                    "type": "Docker"
                },
                "integration_props": {},
                "is_reeval": true,
                "request_source": "PLATFORM_SCANNER",
                "scan_batch_id": "a1234546-a6a3-4509-a1e9-123283a1020e-1636768866551654123",
                "scan_request_props": {
                    "data_format_version": "1.0",
                    "props": {
                        "data_format_version": "1.0",
                        "scanner_version": "0.1.0"
                    },
                    "scanCompletionUtcTime": 1636768866,
                    "scan_start_time": 1636768865,
                    "scanner_version": "0.2.2"
                },
                "vuln_batch_id": "ABCD1A1234AB123A1AB12AB1BD867B123",
                "vuln_created_time": "2022-11-14 00:07:45.736000000"
            },
            "evalGuid": "0a1234567891a1230f2a12a0a12b12ab",
            "featureKey": {
                "name": "example-2",
                "namespace": "alpine:test",
                "version": "1.00.0-r1"
            },
            "featureProps": {
                "feed": "lacework",
                "introduced_in": "example introduced",
                "layer": "sha256:sha256:1234d8c89e19b4b4abcdd4af13d64150ba3d482445d820ae1f6ba71ed6812345",
                "src": "",
                "version_format": "apk"
            },
            "fixInfo": {
                "fix_available": 1,
                "fixed_version": "1.20.00-r0"
            },
            "imageId": "sha256:123d67f5861237689554fa4a2121441e1230dbab9416fccd7d675cfb34476abcd",
            "severity": "Critical",
            "startTime": "2022-11-14T00:20:57.367Z",
            "status": "VULNERABLE",
            "vulnId": "CVE-2020-24215"
        }
    ]
}`), &assessment)
	if err != nil {
		log.Fatal(err)
	}
	return assessment
}
