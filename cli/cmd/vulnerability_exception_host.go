//
// Author:: Darren Murray(<darren.murray@lacework.net>)
// Copyright:: Copyright 2021, Lacework Inc.
// License:: Apache License, Version 2.0
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//

package cmd

import (
	"strings"

	"github.com/AlecAivazis/survey/v2"

	"github.com/lacework/go-sdk/api"
)

func createHostVulnerabilityException() (string, error) {
	questions := []*survey.Question{
		{
			Name:     "name",
			Prompt:   &survey.Input{Message: "Name: "},
			Validate: survey.Required,
		},
		{
			Name:     "description",
			Prompt:   &survey.Input{Message: "Description: "},
			Validate: survey.Required,
		},
		{
			Name: "reason",
			Prompt: &survey.Select{
				Message: "Exception Reason: ",
				Options: []string{"Accepted Risk", "False Positive", "Compensating Controls", "Fix Pending", "Other"},
			},
			Validate: survey.Required,
		},
		{
			Name: "includeCriteria",
			Prompt: &survey.MultiSelect{
				Message: "Select Vulnerability Criteria to set: ",
				Options: []string{"CVEs", "Packages", "Severities", "Fixable"}},
			Validate: survey.MinItems(1),
		},
		{
			Name: "includeScope",
			Prompt: &survey.MultiSelect{
				Message: "Select Resource Scope criteria to set: ",
				Options: []string{"Namespaces", "Hostnames", "External IPs", "Cluster Names"}},
			Validate: survey.MinItems(1),
		},
	}

	answers := struct {
		Name            string
		Description     string   `survey:"description"`
		Reason          string   `survey:"reason"`
		Severities      []string `survey:"severities"`
		Cves            string   `survey:"cves"`
		Packages        string   `survey:"packages"`
		Fixable         bool     `survey:"fixable"`
		Hostname        string   `survey:"hostname"`
		ExternalIP      string   `survey:"externalIp"`
		ClusterName     string   `survey:"clusterName"`
		Namespace       string   `survey:"namespace"`
		IncludeCriteria []string `survey:"includeCriteria"`
		IncludeScope    []string `survey:"includeScope"`
	}{}

	err := survey.Ask(questions, &answers, survey.WithIcons(promptIconsFunc))
	if err != nil {
		return "", err
	}

	err = askVulnerabilityExceptionCriteria(&answers, answers.IncludeCriteria)
	if err != nil {
		return "", err
	}

	err = askVulnerabilityExceptionHostResourceScope(&answers, answers.IncludeScope)
	if err != nil {
		return "", err
	}

	vuln := api.NewVulnerabilityException(answers.Name, api.VulnerabilityExceptionConfig{
		Description:     answers.Description,
		Type:            api.VulnerabilityExceptionTypeHost,
		ExceptionReason: api.NewVulnerabilityExceptionReason(answers.Reason),
		Severities:      api.NewVulnerabilityExceptionSeverities(answers.Severities),
		Cve:             strings.Split(answers.Cves, "\n"),
		Package:         transformVulnerabilityExceptionPackages(answers.Packages),
		Fixable:         answers.Fixable,
		ResourceScope: api.VulnerabilityExceptionHostResourceScope{
			Hostname:    strings.Split(answers.Hostname, "\n"),
			ExternalIP:  strings.Split(answers.ExternalIP, "\n"),
			ClusterName: strings.Split(answers.ClusterName, "\n"),
			Namespace:   strings.Split(answers.Namespace, "\n"),
		},
	})

	cli.StartProgress(" Creating host vulnerability exception...")
	vulnResp, err := cli.LwApi.V2.VulnerabilityExceptions.CreateVulnerabilityExceptionsHost(vuln)
	cli.StopProgress()
	return vulnResp.Data.Guid, err
}

func askVulnerabilityExceptionHostResourceScope(answers interface{}, criteria []string) error {
	var questions []*survey.Question
	for _, c := range criteria {
		if c == "Namespaces" {
			questions = append(questions,
				&survey.Question{Name: "namespace",
					Prompt: &survey.Multiline{Message: "List of Namespaces:"},
				})
			continue
		}

		if c == "Hostnames" {
			questions = append(questions,
				&survey.Question{Name: "hostname",
					Prompt: &survey.Multiline{Message: "List of Hostnames:"},
				})
			continue
		}

		if c == "External IPs" {
			questions = append(questions,
				&survey.Question{Name: "externalIp",
					Prompt: &survey.Multiline{Message: "List of External IPs:"}})
			continue
		}

		if c == "Cluster Names" {
			questions = append(questions,
				&survey.Question{
					Name:   "clusterName",
					Prompt: &survey.Multiline{Message: "List of ClusterNames:"},
				})
			continue
		}
	}

	err := survey.Ask(questions, answers, survey.WithIcons(promptIconsFunc))
	if err != nil {
		return err
	}
	return nil
}
